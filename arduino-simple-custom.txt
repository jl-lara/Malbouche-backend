/*
 * VERSIÓN SIMPLE SIN ArduinoJson
 * Si no quieres instalar librerías adicionales
 */

// Variables globales para movimiento personalizado
bool movimientoPersonalizadoActivo = false;
unsigned long inicioMovimientoPersonalizado = 0;
unsigned long duracionMovimientoPersonalizado = 0;
String dirHorasPersonalizado = "horario";
String dirMinutosPersonalizado = "horario";
int velHorasPersonalizado = 50;
int velMinutosPersonalizado = 50;

// Función helper para extraer valor de JSON simple
String extraerValorJSON(String json, String clave) {
  int inicio = json.indexOf("\"" + clave + "\":");
  if (inicio == -1) return "";
  
  inicio = json.indexOf(":", inicio) + 1;
  while (inicio < json.length() && (json.charAt(inicio) == ' ' || json.charAt(inicio) == '\t')) inicio++;
  
  if (json.charAt(inicio) == '"') {
    // Valor string
    inicio++;
    int fin = json.indexOf("\"", inicio);
    return json.substring(inicio, fin);
  } else {
    // Valor numérico
    int fin = inicio;
    while (fin < json.length() && (isDigit(json.charAt(fin)) || json.charAt(fin) == '.')) fin++;
    return json.substring(inicio, fin);
  }
}

// Agregar en setup():
server.on("/custom", HTTP_POST, [](){
  if (server.hasArg("plain")) {
    String body = server.arg("plain");
    
    Serial.println("=== MOVIMIENTO PERSONALIZADO RECIBIDO ===");
    Serial.println(body);
    
    // Extraer valores manualmente
    String nombre = extraerValorJSON(body, "nombre");
    if (nombre == "") nombre = "Movimiento personalizado";
    
    dirHorasPersonalizado = extraerValorJSON(body, "dirHoras");
    if (dirHorasPersonalizado == "") dirHorasPersonalizado = "horario";
    
    dirMinutosPersonalizado = extraerValorJSON(body, "dirMinutos");
    if (dirMinutosPersonalizado == "") dirMinutosPersonalizado = "horario";
    
    String velHorasStr = extraerValorJSON(body, "velHoras");
    velHorasPersonalizado = (velHorasStr == "") ? 50 : velHorasStr.toInt();
    
    String velMinutosStr = extraerValorJSON(body, "velMinutos");
    velMinutosPersonalizado = (velMinutosStr == "") ? 50 : velMinutosStr.toInt();
    
    String duracionStr = extraerValorJSON(body, "duracion");
    int duracionSeg = (duracionStr == "") ? 60 : duracionStr.toInt();
    
    // Validar valores
    velHorasPersonalizado = constrain(velHorasPersonalizado, 1, 100);
    velMinutosPersonalizado = constrain(velMinutosPersonalizado, 1, 100);
    duracionSeg = constrain(duracionSeg, 1, 300);
    
    Serial.printf("Ejecutando: %s\n", nombre.c_str());
    Serial.printf("Horas: %s a velocidad %d\n", dirHorasPersonalizado.c_str(), velHorasPersonalizado);
    Serial.printf("Minutos: %s a velocidad %d\n", dirMinutosPersonalizado.c_str(), velMinutosPersonalizado);
    Serial.printf("Duración: %d segundos\n", duracionSeg);
    
    // Detener modo actual
    modoActual = STOP;
    apagarMotor(motorHoras);
    apagarMotor(motorMin);
    
    // Configurar movimiento personalizado
    duracionMovimientoPersonalizado = duracionSeg * 1000;
    inicioMovimientoPersonalizado = millis();
    movimientoPersonalizadoActivo = true;
    
    server.send(200, "application/json", "{\"success\":true,\"message\":\"Movimiento personalizado iniciado\"}");
    Serial.println("Movimiento personalizado iniciado");
    
  } else {
    server.send(400, "application/json", "{\"success\":false,\"error\":\"No se recibieron datos\"}");
  }
});

// MISMO CÓDIGO PARA EL LOOP() que en la versión anterior
